# 概述
## 题目
题目：
1. 分行业以30家A股上市公司为例，研究2007-2013年期 间25个财务指标对股价收益率的贡献（用季报数据）。
2. 选择前6大贡献的财务指标计算权重，编制财务指标强度指数，并与其2014的股价情况进行对比看是否与股价表现相符，并分析原因。

方案：
我们根据申万的行业分类，选取了生物医药行业的30只股票进行研究。
考察两个因素之间的关系
1. 上市公司的季度公告的财务数据，共25个指标
2. 在公告5个交易日内的股价涨跌情况

试图寻找这两个因素之间的关系。

我们选取的30只股票为：
【【30只股票的数据】】
同时，我们选取了25个财务指标：
【【25个财务指标】】
这些指标的含义是
【【25个财务指标的含义】】
## 方法
对于第一问，我们尝试通过两种方法进行研究。分别是
1. 线性回归
2. 岭回归
对于第二问，我们尝试通过三种方法选取前6大贡献度的财务指标
1. 根据回归方程的权重，从高到低选择
3. 采用主成分分析（PCA）方法，将25个财务指标降维成6个特征

# 线性回归
## 线性回归的解释
### 线性回归方程
线性回归：通过特征的线性组合来进行预测。
$$
h(w) = w_0 + w_1x_1 + w_2x_2 + ··· + w_dx_d
$$
$$
h(w) = \bold{w}^T \bold{x}
$$
其中w，x为矩阵。
$$
\bold{w} =  \left[
 \begin{matrix}
   w_0 \\
   w_1 \\
   \vdots \\
   w_{m}
  \end{matrix}
  \right] \ 
\bold{x} =  \left[
 \begin{matrix}
   1 \\
   x_1 \\
   \vdots \\
   x_{m}
  \end{matrix}
  \right]
$$
同时，我们定义一个损失函数，计作J(w)
$$
J(\bold{w}) = \sum_{i=1}^m(h_w(x_i) - y_i)^2
$$
其中
* y_i为第i个样本的真实值
* h_w(x_i)为第i个样本，在模型h_w下的预测值

### 线性回归系数的求解
我们要求解一组w，使得损失函数J(w)的值最小。
通常有两种方法：
1. 正规方程
2. 梯度下降

#### 正规方程法
正规方程的公式
$$
\bold{W} = (\bold{X}^T\bold{X})^{-1}\bold{X}^T\bold{y}
$$
其中
* X是特征值矩阵
* y是目标值矩阵

#### 梯度下降法
我们以只有一个变量的为例。
即，只有w_0和w_1两个参数。
则有
$$
w_0 = -w_0 - \alpha\frac{\partial J(w_0,w_1)}{\partial w_0}
$$
$$
w_1 = -w_1 - \alpha\frac{\partial J(w_0,w_1)}{\partial w_1}
$$
其中 
* J(w_0,w_1)是损失函数
* \alpha是称为学习率

## 第一问
### 线性回归的实现
我们通过Python实现线性回归。
代码分为以下部分。
1. 读取和处理数据
2. 正规方程法求解
3. 梯度下降法求解

#### 读取和处理数据
代码如下：
``` Python
#%%

# 导入pandas包，以读取数据
import pandas as pd

# 读取 data.xlsx 这个文件，q1这个sheet页的数据
df_q1 = pd.read_excel('data.xlsx',sheet_name='q1')

# 把正跌幅数据作为y
y_train = df_q1['涨跌幅'].values
# 把其他25个财务指标作为x
x_train = df_q1.drop(['证券代码','证券名称','年度','季度','报告期','日期1（报告发布日）','股价1（报告发布日股价）','日期2（发布日后5日）','股价2（发布日后5日股价）','涨跌幅'],axis=1).values

# 打印财务指标
print(df_q1.drop(['证券代码','证券名称','年度','季度','报告期','日期1（报告发布日）','股价1（报告发布日股价）','日期2（发布日后5日）','股价2（发布日后5日股价）','涨跌幅'],axis=1).columns.values.tolist())
```
运行结果：
``` Code
['销售毛利率', '总资产周转率', '息税前利润/营业总收入', '流动资产周转率', '营业总成本/营业总收入', '经营活动净收益/利润总额', '固定资产周转率', '经营活动产生的现金流净额/营业收入', '扣除非经常损益后的净利润/净利润', '营业外收支净额/利润总额', '总资产报酬率ROA', '扣除非经常性损益的ROE（扣除/摊薄）', '销售商品提供劳务收到的现金/营业收入', '应收账款周转率', '销售期间费用率', 'ROIC', '经营活动产生的现金流量净额/负债合计', '营业总收入(合并报表，亿元)', '净资产收益率（年化）', '存货周转率', '总资产净利润ROA', '净资产收益率（摊薄）', '归属母公司股东的权益/负债合计', '归属母公司股东的净利润-扣除非经常损益（同比增长率）', '总资产负债率']
```
#### 正规方程法求解
代码如下：
``` Python
#%%

# 导入正规方程的包
from sklearn.linear_model import LinearRegression

print('正规方程')
# 实例化正规方程
lr = LinearRegression()
# 训练模型
lr.fit(x_train,y_train)
# 打印模型的系数
print(lr.coef_)
```
运行结果：
``` Code
正规方程
[ 3.21523548e-04  1.24377559e-02  8.12393296e-05 -1.34994789e-02
  8.89782463e-04 -7.05145937e-06 -4.48405192e-04  1.00783342e-04
  9.56534823e-07 -7.34734904e-05 -2.71302628e-03  1.07909736e-04
  2.08276654e-05  6.54633857e-05 -4.41750652e-04 -2.43751108e-03
  1.52893275e-02  3.05942090e-05  4.97117594e-04  9.89231145e-04
  7.11994193e-03 -1.12882209e-03 -1.79840744e-03 -5.15626140e-06
  4.88520571e-04]
```
为了便于查看，我们整理如下：
1. 销售毛利率：3.21523548e-04
2. 总资产周转率：1.24377559e-02
3. 息税前利润/营业总收入：8.12393296e-05
4. 流动资产周转率：-1.34994789e-02
5. 营业总成本/营业总收入：8.89782463e-04
6. 经营活动净收益/利润总额：-7.05145937e-06
7. 固定资产周转率：-4.48405192e-04
8. 经营活动产生的现金流净额/营业收入：1.00783342e-04
9. 扣除非经常损益后的净利润/净利润：9.56534823e-07
10. 营业外收支净额/利润总额：-7.34734904e-05
11. 总资产报酬率ROA：-2.71302628e-03
12. 扣除非经常性损益的ROE（扣除/摊薄）：1.07909736e-04
13. 销售商品提供劳务收到的现金/营业收入：2.08276654e-05
14. 应收账款周转率：6.54633857e-05
15. 销售期间费用率：-4.41750652e-04
16. ROIC：-2.43751108e-03
17. 经营活动产生的现金流量净额/负债合计：1.52893275e-02
18. 营业总收入(合并报表，亿元)：3.05942090e-05
19. 净资产收益率（年化）：4.97117594e-04
20. 存货周转率：9.89231145e-04
21. 总资产净利润ROA：7.11994193e-03
22. 净资产收益率（摊薄）：-1.12882209e-03
23. 归属母公司股东的权益/负债合计：-1.79840744e-03
24. 归属母公司股东的净利润-扣除非经常损益（同比增长率）：-5.15626140e-06
25. 总资产负债率：4.88520571e-04

#### 梯度下降法求解
代码如下：
```Python
#%%

# 导入梯度下降的包
from sklearn.linear_model import SGDRegressor

print('梯度下降')
# 实例化梯度下降
sr = SGDRegressor()
# 训练模型
sr.fit(x_train,y_train)
# 打印模型的系数
print(sr.coef_)
```
**特别注意：由于梯度下降法自身的特点，每次求解均可能得到不同的解，不能说明每个财务指标的权重，运行结果略。**
## 第二问
我们通过两种方法进行特征选择：
1. 根据上一问线性回归方程，选择线性回归系数最大的六个财务指标重新进行分析。
2. 用主成分分析（PCA），将25个财务指标降维成6个特征。
### 选择回归系数最大的六个财务指标
在上一问中，得到的系数最大的六个财务指标为
1. 经营活动产生的现金流量净额/负债合计：1.52893275e-02
2. 流动资产周转率：-1.34994789e-02
3. 总资产周转率：1.24377559e-02
4. 总资产净利润ROA：7.11994193e-03
5. 总资产报酬率ROA：-2.71302628e-03
6. ROIC：-2.43751108e-03

同时，我们用2014年的数据对模型进行评估。



正规方程
[ 0.02572462  0.03291155  0.02514813 -0.06389033  0.05340982 -0.07485842
 -0.03077499  0.01570608  0.01556237 -0.13778144 -0.16308978  0.01070896
  0.00241851  0.01997719 -0.03004152 -0.18054352  0.04669666  0.00571094
  0.06063806  0.01925796  0.42843823 -0.11353693 -0.02181666 -0.10771239
  0.04004559]

0.42843823   总资产净利润ROA
0.18054352  ROIC
-0.16308978  总资产报酬率ROA
-0.13778144 营业外收支净额/利润总额
-0.11353693 净资产收益率（摊薄）
-0.10771239  归属母公司股东的净利润-扣除非经常损益（同比增长率）